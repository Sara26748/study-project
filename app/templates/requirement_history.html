{% extends "base.html" %} {% block title %}Anforderung - Details{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <a
        href="{{ url_for('main.manage_project', project_id=req.project_id) }}"
        class="btn btn-outline-primary border-0 bg-light text-primary shadow-sm mb-2 d-inline-flex align-items-center"
        style="transition: all 0.2s ease"
      >
        <i class="bi bi-arrow-left me-2"></i> Zurück zum Projekt
      </a>
      <h2 class="mb-0">Anforderung: {{ version.title }}</h2>
      <p class="text-muted mb-0">Version {{ version.version_label }}</p>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs mb-4" id="requirementTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="details-tab"
        data-bs-toggle="tab"
        data-bs-target="#details"
        type="button"
        role="tab"
        aria-controls="details"
        aria-selected="true"
      >
        <i class="bi bi-file-text me-2"></i>Details
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="history-tab"
        data-bs-toggle="tab"
        data-bs-target="#history"
        type="button"
        role="tab"
        aria-controls="history"
        aria-selected="false"
      >
        <i class="bi bi-clock-history me-2"></i>Änderungshistorie {% if
        timeline|length > 1 %}
        <span class="badge bg-primary ms-1">{{ timeline|length }}</span>
        {% endif %}
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="comments-tab"
        data-bs-toggle="tab"
        data-bs-target="#comments"
        type="button"
        role="tab"
        aria-controls="comments"
        aria-selected="false"
      >
        <i class="bi bi-chat-left-text me-2"></i>Kommentare
        <span class="badge bg-primary ms-1" id="commentsCount">0</span>
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="requirementTabContent">
    <!-- Details Tab -->
    <div
      class="tab-pane fade show active"
      id="details"
      role="tabpanel"
      aria-labelledby="details-tab"
    >
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-file-text me-2"></i>Details (Version {{
            version.version_label }})
          </h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Titel:</strong>
              <p>{{ version.title }}</p>
            </div>
            <div class="col-md-6">
              <strong>Status:</strong>
              <p>
                <span class="badge bg-{{ version.get_status_color() }}"
                  >{{ version.status }}</span
                >
              </p>
            </div>
          </div>
          <div class="mb-3">
            <strong>Beschreibung:</strong>
            <p class="text-secondary">{{ version.description }}</p>
          </div>
          <div class="row">
            <div class="col-md-6">
              <strong>Kategorie:</strong>
              <p>{{ version.category or "–" }}</p>
            </div>
            <div class="col-md-6">
              <strong>Quantifizierbar:</strong>
              <p>
                {% set custom_data = version.get_custom_data() %} {% set
                is_quantifiable = custom_data.get('is_quantifiable', 'false') ==
                'true' %}
                <i
                  class="bi {% if is_quantifiable %}bi-check-circle-fill text-success{% else %}bi-circle text-muted{% endif %}"
                ></i>
                {% if is_quantifiable %}Ja{% else %}Nein{% endif %}
              </p>
            </div>
          </div>

          {% set custom_columns = req.project.get_custom_columns() %} {% if
          custom_columns %}
          <div class="mb-3">
            <strong>Zusätzliche Felder:</strong>
            <div class="row mt-2">
              {% for col in custom_columns %}
              <div class="col-md-6 mb-2">
                <strong>{{ col }}:</strong> {{ custom_data.get(col, "–") }}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div
      class="tab-pane fade"
      id="history"
      role="tabpanel"
      aria-labelledby="history-tab"
    >
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-clock-history me-2"></i>Änderungshistorie
          </h5>
        </div>
        <div class="card-body">
          {% if timeline %}
          <div class="timeline">
            {% for entry in timeline %}
            <div class="timeline-item mb-3">
              <div class="d-flex position-relative">
                <!-- Timeline Line -->
                {% if not loop.last %}
                <div
                  class="timeline-line position-absolute"
                  style="
                    left: 20px;
                    top: 50px;
                    width: 2px;
                    height: calc(100% + 1rem);
                    background: #dee2e6;
                  "
                ></div>
                {% endif %}

                <!-- Timeline Icon -->
                <div
                  class="timeline-icon me-3 position-relative"
                  style="z-index: 1"
                >
                  {% if entry.type == 'created' %}
                  <div
                    class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center shadow-sm"
                    style="width: 42px; height: 42px"
                  >
                    <i class="bi bi-plus-circle-fill fs-5"></i>
                  </div>
                  {% else %}
                  <div
                    class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center shadow-sm"
                    style="width: 42px; height: 42px"
                  >
                    <i class="bi bi-pencil-fill fs-6"></i>
                  </div>
                  {% endif %}
                </div>

                <!-- Timeline Content -->
                <div class="flex-grow-1 pb-3">
                  <div class="card border shadow-sm">
                    <div class="card-body p-3">
                      <div
                        class="d-flex justify-content-between align-items-start mb-2"
                      >
                        <div class="flex-grow-1">
                          {% if entry.type == 'created' %}
                          <span class="badge bg-success mb-2">
                            <i class="bi bi-person-plus-fill me-1"></i>Erstellt
                          </span>
                          {% else %}
                          <span class="badge bg-primary mb-2">
                            <i class="bi bi-pencil-fill me-1"></i>Bearbeitet
                          </span>
                          {% endif %}
                          <div class="mt-1">
                            <strong class="text-dark"
                              >{{ entry.user.email }}</strong
                            >
                            <small class="text-muted ms-2">
                              <i class="bi bi-clock me-1"></i>
                              {{ entry.timestamp.strftime('%d.%m.%Y um %H:%M
                              Uhr') }}
                            </small>
                          </div>
                        </div>
                      </div>

                      {% if entry.changes %}
                      <div class="mt-2 pt-2 border-top">
                        {% for field, change in entry.changes.items() %} {% if
                        field != 'action' %}
                        <div class="mb-2">
                          <small class="text-muted d-block mb-1">
                            <strong
                              >{{ field|replace('_', ' ')|title|replace('Custom
                              ', '') }}:</strong
                            >
                          </small>
                          <div class="ps-3">
                            <code class="text-primary">{{ change }}</code>
                          </div>
                        </div>
                        {% endif %} {% endfor %}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-info-circle fs-1 d-block mb-2"></i>
            <p>Noch keine Änderungshistorie vorhanden.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Comments Tab -->
    <div
      class="tab-pane fade"
      id="comments"
      role="tabpanel"
      aria-labelledby="comments-tab"
    >
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-chat-left-text me-2"></i>Kommentare
          </h5>
        </div>
        <div class="card-body">
          <!-- Comment Form -->
          <div class="mb-4">
            <div class="mb-3 position-relative">
              <label for="commentText" class="form-label"
                >Neuer Kommentar</label
              >

              <textarea
                class="form-control"
                id="commentText"
                rows="3"
                placeholder="Kommentar schreiben... Tippe @ und dann einen Buchstaben."
              ></textarea>

              <!-- Mention Suggestions -->
              <div
                id="mentionSuggestions"
                class="list-group shadow"
                style="
                  display: none;
                  position: absolute;
                  z-index: 2000;
                  left: 0;
                  right: 0;
                  top: 100%;
                  margin-top: 6px;
                  max-height: 220px;
                  overflow: auto;
                "
              ></div>

              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Tippe <strong>@</strong> + Buchstabe, um Teammitglieder
                vorzuschlagen.
              </div>
            </div>
            <button class="btn btn-primary" onclick="addComment()">
              <i class="bi bi-send me-2"></i>Kommentar hinzufügen
            </button>
          </div>

          <hr />

          <!-- Comments List -->
          <div id="commentsList">
            <div class="text-center text-muted py-4">
              <i class="bi bi-chat-left-text fs-1 d-block mb-2"></i>
              Lade Kommentare...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
      const versionId = {{ version.id }};
      const projectId = {{ req.project_id }};


      // Load comments on page load and when comments tab is shown
      document.getElementById('comments-tab')?.addEventListener('shown.bs.tab', loadComments);

      function loadComments() {
        fetch(`/requirement_version/${versionId}/comments`)
          .then(response => response.json())
          .then(data => {
            const list = document.getElementById('commentsList');
            const countBadge = document.getElementById('commentsCount');

            if (!data.comments || data.comments.length === 0) {
              list.innerHTML = `
                <div class="text-center text-muted py-4">
                  <i class="bi bi-chat-left-text fs-1 d-block mb-2"></i>
                  Noch keine Kommentare. Sei der Erste!
                </div>
              `;
              countBadge.textContent = '0';
            } else {
              // Count total comments including replies
              let totalCount = 0;
              function countComments(comments) {
                comments.forEach(comment => {
                  totalCount++;
                  if (comment.replies && comment.replies.length > 0) {
                    countComments(comment.replies);
                  }
                });
              }
              countComments(data.comments);
              countBadge.textContent = totalCount;

              list.innerHTML = renderComments(data.comments);
            }
          })
          .catch(error => {
            console.error('Error loading comments:', error);
            document.getElementById('commentsList').innerHTML = `
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>Fehler beim Laden der Kommentare.
              </div>
            `;
          });
      }

      function renderComments(comments, depth = 0) {
        return comments.map(comment => {
          const repliesHtml = comment.replies && comment.replies.length > 0
            ? `<div class="ms-4 mt-3">${renderComments(comment.replies, depth + 1)}</div>`
            : '';

          const timeAgo = getTimeAgo(comment.created_at);
          const isEdited = comment.created_at !== comment.updated_at;

          return `
            <div class="comment-item mb-3 ${depth > 0 ? 'border-start border-2 ps-3' : ''}" data-comment-id="${comment.id}">
              <div class="d-flex align-items-start">
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.875rem; font-weight: 600; flex-shrink: 0;">
                  ${comment.author.name[0].toUpperCase()}
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center mb-1">
                    <strong class="me-2">${escapeHtml(comment.author.name)}</strong>
                    <small class="text-muted">${timeAgo}</small>
                    ${isEdited ? '<small class="text-muted ms-2">(bearbeitet)</small>' : ''}
                  </div>
                  <div class="comment-text mb-2">${formatCommentText(comment.text)}</div>
                  <div class="comment-actions">
                    <button class="btn btn-link btn-sm p-0 text-muted" onclick="replyToComment(${comment.id})">
                      <i class="bi bi-reply me-1"></i>Antworten
                    </button>
                  </div>
                  ${repliesHtml}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      function formatCommentText(text) {
        // Format @mentions
        return escapeHtml(text).replace(/@(\w+(?:\.\w+)*@?\w*\.?\w*)/g, '<span class="badge bg-primary">@$1</span>');
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function getTimeAgo(dateString) {
        if (!dateString) return 'gerade eben';

        const date = new Date(dateString);
        const now = new Date();

        if (isNaN(date.getTime())) {
          return 'gerade eben';
        }

        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 0 || seconds < 10) return 'gerade eben';
        if (seconds < 60) return 'gerade eben';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `vor ${minutes} Min.`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `vor ${hours} Std.`;
        const days = Math.floor(hours / 24);
        if (days < 7) return `vor ${days} Tag${days > 1 ? 'en' : ''}`;
        return date.toLocaleDateString('de-DE');
      }

      function addComment(parentId = null) {
        const textarea = document.getElementById('commentText');
        const text = textarea.value.trim();

        if (!text) {
          alert('Bitte geben Sie einen Kommentar-Text ein.');
          return;
        }

        const actualParentId = textarea.getAttribute('data-parent-id') || parentId;

        fetch(`/requirement_version/${versionId}/comments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: text,
            parent_comment_id: actualParentId ? parseInt(actualParentId) : null
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('Fehler: ' + data.error);
          } else {
            textarea.value = '';
            textarea.removeAttribute('data-parent-id');
            loadComments();
          }
        })
        .catch(error => {
          console.error('Error adding comment:', error);
          alert('Fehler beim Hinzufügen des Kommentars.');
        });
      }

      function replyToComment(parentId) {
        const textarea = document.getElementById('commentText');
        textarea.setAttribute('data-parent-id', parentId);
        textarea.focus();
        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      const textarea = document.getElementById('commentText');
  const suggBox = document.getElementById('mentionSuggestions');

  let mentionTimer = null;
  let mentionState = null; // { start, end, query }

  function getMentionAtCursor(value, cursorPos) {
    let i = cursorPos - 1;
    while (i >= 0 && !/\s/.test(value[i])) i--;
    const start = i + 1;
    const token = value.slice(start, cursorPos);

    if (token.startsWith('@') && token.length >= 2) {
      return { start, end: cursorPos, query: token.slice(1) };
    }
    return null;
  }

  function hideSuggestions() {
    if (!suggBox) return;
    suggBox.style.display = 'none';
    suggBox.innerHTML = '';
    mentionState = null;
  }

  function showSuggestions(users) {
    if (!suggBox) return;
    if (!users || users.length === 0) return hideSuggestions();

    suggBox.innerHTML = users.map(u => `
      <button type="button"
        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mention-item"
        data-username="${escapeHtml(u.username)}">
        <span>
          <strong>@${escapeHtml(u.username || u.email)}</strong>
          <small class="text-muted ms-2">${escapeHtml(u.email)}</small>
        </span>
      </button>
    `).join('');

    suggBox.style.display = 'block';
  }

  function insertMention(username) {
    if (!mentionState) return;

    const value = textarea.value;
    const before = value.slice(0, mentionState.start);
    const after = value.slice(mentionState.end);

    const mentionText = `@${username} `;
    textarea.value = before + mentionText + after;

    const newCursor = (before + mentionText).length;
    textarea.focus();
    textarea.setSelectionRange(newCursor, newCursor);

    hideSuggestions();
  }

  function fetchMentionSuggestions(query) {
    fetch(`/project/${projectId}/mention_suggestions?q=${encodeURIComponent(query)}`)
      .then(r => r.json())
      .then(data => showSuggestions(data.users || []))
      .catch(() => hideSuggestions());
  }

  textarea?.addEventListener('input', () => {
    const cursorPos = textarea.selectionStart;
    const m = getMentionAtCursor(textarea.value, cursorPos);

    if (!m) return hideSuggestions();
    mentionState = m;

    clearTimeout(mentionTimer);
    mentionTimer = setTimeout(() => fetchMentionSuggestions(m.query), 150);
  });

  // Click (mousedown verhindert blur)
  suggBox?.addEventListener('mousedown', (e) => {
    const btn = e.target.closest('.mention-item');
    if (!btn) return;
    e.preventDefault();

    const username = btn.getAttribute('data-username');
    if (username) insertMention(username);
  });

  // Klick außerhalb -> schließen
  document.addEventListener('click', (e) => {
    if (!suggBox) return;
    if (!suggBox.contains(e.target) && e.target !== textarea) hideSuggestions();
  });
</script>

<style>
  .timeline {
    position: relative;
  }

  .timeline-item {
    position: relative;
  }

  .timeline-icon {
    flex-shrink: 0;
  }

  .timeline-line {
    z-index: 0;
  }
</style>
{% endblock %}
